rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
       return request.auth.token.role == 'admin';
    }

    function signedIn() {
      return request.auth.uid != null;
    }

    match /pools/{pool} {
      function rsrcData() {
        return resource.data;
      }

      function reqRsrcData() {
        return request.resource.data;
      }

      function isOwn() {
        return rsrcData().userId == request.auth.uid || isAdmin();
      }

      function readGuard() {
        return rsrcData().userId == request.auth.uid || isAdmin();
      }

      function writeGuard() {
        return (
                 isOwn() &&
                 rsrcData().flags.isPaid == false &&
                 rsrcData().meta.poolName == reqRsrcData().meta.poolName // Not allowed to change value
               ) ||
               isAdmin();
      }

      function parentDoc() {
        return get(/databases/$(database)/documents/pools/$(pool)).data
      }

      match /forms/{form} {
        function isOwn() {
          return parentDoc().userId == request.auth.uid;
        }

        allow get:    if isOwn();
        allow create: if isOwn();
        allow update: if isOwn() &&
                         rsrcData().page1.meta.poolName == reqRsrcData().page1.meta.poolName && // Not allowed to change value
                         parentDoc().flags.isPaid == false;
        allow delete: if isOwn() &&
                         parentDoc().flags.isPaid == false;

      }

      allow create: if signedIn()
                    && writeGuard();
      allow read:   if signedIn()
                    && readGuard();
      allow update: if signedIn()
                    && readGuard()
                    && writeGuard();
      allow delete: if signedIn()
                    && readGuard()
                    && writeGuard()
                    && rsrcData().flags.isPaid == false;
    }
  }
}
