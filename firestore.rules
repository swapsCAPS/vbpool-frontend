service cloud.firestore {
  match /databases/{database}/documents {
    match /pools/{pool} {
      function signedIn() {
        return request.auth.uid != null;
      }

      function readGuard() {
        return resource.data.userId == request.auth.uid
        || request.auth.token.role == 'admin';
      }

      function writeGuard() {
        return request.resource.data.userId == request.auth.uid
        || request.auth.token.role == 'admin';
      }

      allow create: if signedIn()
                    && writeGuard();
      allow read:   if signedIn()
                    && readGuard();
      allow update: if signedIn()
                    && readGuard()
                    && writeGuard();
      allow delete: if signedIn()
                    && readGuard()
                    && writeGuard()
                    && resource.data.isPayed == false;
    }
  }
}
